name: 'Run the Windows App Certification Kit'
description: 'Allows to run the Windows App Certification Kit (WACK) and generate test results'
inputs:
  package-path:
    description: "Relative path of the target package to test with the WACK (appxbundle or msixbundle file)"
    required: true
  report-name:
    description: "Desired name of the certification report"
    required: true
  ignore-rules:
    description: "List of WACK rules to ignore separated by a comma (optional)"
    required: false
  threat-as-warning-rules:
    description: "List of WACK rules to threat as warning if failed separated by a comma (optional)"
    required: false

outputs:
  report-path:
    description: "Path of the certification report"
    value: ${{ steps.certification.outputs.reportPath }}

runs:
  using: "composite"
  steps:
    - name: Ensure Windows runner type
      shell: pwsh
      run: >
        if (-not $IsWindows) {
            Write-Host "ERROR: this action is only compatible with Windows!"
            Write-Host
            Exit 1
        }

    - name: Run the Windows App Certification Kit
      id: certification
      shell: pwsh
      run: >
        ${{ github.action_path }}\scripts\Run-WACK.ps1
        "${{ inputs.package-path }}"
        "${{ inputs.report-name }}"

    - name: Analyze the Windows App Certificat Kit results
      id: analysis
      shell: pwsh
      run: >
        ${{ github.action_path }}\scripts\Analyze-Results.ps1
        "${{ steps.certification.outputs.reportPath }}"
        "${{ inputs.ignore-rules }}"
        "${{ inputs.threat-as-warning-rules }}"

    - name: "Create a check run"
      uses: actions/github-script@v6
      env:
        parameter_url: '${{ github.event.workflow_run.html_url }}'
      with:
        debug: ${{ secrets.ACTIONS_STEP_DEBUG || false }}
        script: |
          await github.rest.checks.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head_sha: context.sha,
            name: "my-check-name",
            status: "completed",
            conclusion: "${{ github.event.workflow_run.conclusion }}",
            details_url: process.env.parameter_url,
            output: {
              title: "${{ steps.analysis.outputs.title }}",
              summary: "${{ steps.analysis.outputs.summary }}"
            },
          });

branding:
  icon: check-circle
  color: green